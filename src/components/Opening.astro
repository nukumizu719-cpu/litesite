---
/**
 * オープニング演出：リロード時は表示、サイト内遷移時は非表示
 */
const bgColor = "#0f172a";
const textColor = "#ffffff";
const typingSpeed = 80;
const waitTime = 800;
---

<div id="opening-overlay" class="fixed inset-0 z-[10000] flex items-center justify-center pointer-events-none" style={`background-color: ${bgColor}; display: none; opacity: 1;`}>
  <div id="typewriter" class="text-3xl md:text-6xl font-bold tracking-tighter" style={`color: ${textColor}; font-family: 'JetBrains Mono', 'Courier New', monospace;`}>
  </div>
</div>

<style>
  #opening-overlay {
    transition: opacity 0.6s ease-in-out, visibility 0.6s;
  }
  #opening-overlay.fade-out {
    opacity: 0;
    visibility: hidden;
  }
  #typewriter::after {
    content: "█";
    margin-left: 8px;
    animation: blink 0.8s step-end infinite;
  }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }
</style>

<script define:vars={{ typingSpeed, waitTime }}>
  const text = "ENTER LITESITE";
  const container = document.getElementById('typewriter');
  const overlay = document.getElementById('opening-overlay');
  
  const STORAGE_KEY = 'litesite_opening_played';
  let i = 0;

  function typeWriter() {
    if (i < text.length) {
      container.innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, typingSpeed);
    } else {
      setTimeout(() => {
        overlay.classList.add('fade-out');
        // 演出完了を記録
        sessionStorage.setItem(STORAGE_KEY, 'true');
        
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 600);
      }, waitTime);
    }
  }

  function initOpening() {
    // 【ロジック修正】
    // 1. ブラウザのナビゲーションタイプを取得
    const navEntries = performance.getEntriesByType('navigation');
    const isReload = navEntries.length > 0 && navEntries[0].type === 'reload';

    // 2. リロードされた場合は、ストレージのフラグを削除して強制表示する
    if (isReload) {
      sessionStorage.removeItem(STORAGE_KEY);
    }

    // 3. フラグチェック
    if (sessionStorage.getItem(STORAGE_KEY)) {
      overlay.style.display = 'none';
      return;
    }

    overlay.style.display = 'flex';
    setTimeout(typeWriter, 300);
  }

  // 初回読み込み・リロード時に実行
  document.addEventListener('DOMContentLoaded', initOpening);
</script>